# 프로세스와 스레드

- 프로세스
    - 프로그램에 대한 각각의 인스턴스 
        - 같은 프로그램을 여러 개 띄운 경우에도 하나의 프로세스를 공유하는 것은 아님
    - 운영체제로부터 주소 공간 파일 메모리 등을 할당받음
    - 리눅스 시스템에서
        - 코드 영역과 라이브러리를 프로세스 간에 공유, 메모리 내에 코드와 라이브러리는 하나만 존재함
        - 변수에 할당되는 공간으로 데이터 세그먼트와 스택 세그먼트는 프로세스를 각각 가지고 잇음
        - 각 프로세스마다 실행 위치를 나타내는 PC도 프로세스별로 관리함
    
- 스레드
    - 한 프로세스 내에서 동작되는 여러 실행의 흐름
        - 프로세스 내의 주소 공간이나 자원들을 대부분 공유하면서 실행됨
    - 메인 스레드 
        - 하나의 프로세스가 생성되면 하나의 스레드가 같이 생성됨
            - 스레드를 추가로 생성하지 않는 한 모든 프로그램 코드는 메인 스레드에서 실행
    - 멀티 스레드
        - 프로세스는 여러 개의 스레드를 가질 수 있음
    
### 프로세스의 개요와 상태 변화

- 프로세스의 개요
    - 프로세스의 정의
        - 1960년대 멀틱스 시스템 운영체제에서 처음사용함
        - IBM 운영체제에서의 작업(TASK)과 같이 사용됨
        - 실행 중인 프로그램
        - 비동기적 행위
        - 실행 중인 프로시저
        - 운영체제에 들어 있는 프로세스 제어 블록
        - 프로세서에 할당하여 실행할 수 있는 개체 디스패치가 가능한 대상
    - 프로그램과 프로세스
        - 프로그램(코드, 정적데이터)이 메모리에 적재되어서 운영체제의 제어를 받으면 프로세스가 됨
    - 시스템 관점
        - 프로그램이 프로세서가되어서 특정 프로세서가 선택이 되는 것
        - 스케줄러 : 프로세스의 실행 순서 결정, 디스크에 저장된 프로그램에 프로세서를 할당해 장치나 메모리 같은 파일 자원을 참조함
                - 프로세스 지원, 협력하여 교차 상태, 보호, 동기화 등 정보를 교환함
          
    - 프로세스 종류
        - 시스템(커널) 프로세스, 사용자 프로세스, 독립 프로세스, 협력 프로세스
                    
                시스템 프로세스 
                    모든 시스템 메모리와 프로세서의 명령에 액세스 할 수 있는 프로세스
                    프로세스 실행 순서를 제어하거나 다른 사용자 및 커널영역을 침범못하게 감시
                    사용자 프로세스를 생성하는 기능
                사용자 프로세스
                    사용자 코드를 수행하는 프로세스
                독립 프로세스
                    다른 프로세스에 영향을 주지 않거나 다른 프로세스의 영향을 받지 않으면서 수행
                협력 프로세스
                    다른 프로세스에 영향을 주거나 다른 프로세스에서 영향을 받는 프로세스
    
    - 프로세스 상태변화와 상태 정보
        - 생성 -> 비실행 -> 디스패치 -> 실행 -> 종료
        - 실행 -> 인터럽트 -> 비실행 -> 디스패치 -> 실행 
    
    - 프로세스의 상태 변화
        - 운영체제가 프로세서 스케줄러를 이용하여 상태 변화를 관리함
            - 작업 스케줄러 : 스풀러가 디스크에 저장한 작업 중 실행할 작업 선정하고 준비리스트에 삽입하여 우선순위를 결정
            - 프로세스 스케줄러 : 선정한 작업의 상태를 변화시키며 프로세스의 생성에서 종료까지 과정을 수행함
    - 시스템 관점에서 본 상태변화
        - 생성 -> 준비 -> 실행 -> 대기 -> 준비 -> 실행 -> 종료
        - 준비 큐 -> 스케줄러가 디스패처에게 명령 -> 준비큐에서 디스패처가 프로세서를 할당
            - 준비 -> 실행 : Dispatch
            - 실행 -> 준비 : Timeout
            - 실행 -> 대기 : Block
            - 대기 -> 준비 : Wakeup
        
    - 프로세서 상태정보
        - 프로세서 제어블록(PCB)
            - 운영체제가 프로세스 제어 시 필요한 프로세스의 상태정보를 저장함
            - 특정 프로세스 정보를 저장하는 데이터 블록이나 레코드
            - 프로세스가 생성되면 메모리에 프로세스 제어 블록이 생성됨
            - 프로세스가 실행을 종료하면 해당 프로세스 제어 블록도 삭제됨
        - 프로세서 제어블록
            - 레지스터 저장영역
                - 누산기, 인덱스 레지스터, 스택포인터 등에 관한 정보로, 컴퓨터 구조에 따라 수나 형태가 다름
                - 인터럽트가 발생하며 ㄴ프로그램 카운터와 함께 저장하여 재 실행할 때 원래대로 복귀 가능
            - 프로세스 스케줄링 정보      
                - 프로세스의 우선순위, 스케줄링 큐에 대한 포인터, 기타 스케줄 매개변수 등이 해당됨
            - 계정정보
                - 프로세서 사용시간, 실제 사용시간, 사용 상한시간, 계정번호 등
            - 입출력 상태정보
                - 특별한 입룿력 요구 프로세스에 할당된 입출력장치, 열린 파일리스트 등
            - 메모리 관리 정보
                - 운영체제가 사용하는 메모리 시스템에 따른 상한, 하한 레지스터, 페이지 테이블이나 세그먼트 테이블 정보 등
    - 프로세서 교환
        - 실행 중인 프로세스의 제어를 다른 프로세스에 넘겨 해당 프로세스가 실행 상태가 되도록 하는 것
        - 프로세스 문맥 교환이 일어나면 프로세스 제어권을 넘기게 되는 프로세서의 레지스터에 있던 내용을 PCB에 저장
    #### 프로세스의 관리
- 프로세스 구조
    -프로세스의 생성 구조
        - 프로세스는 실행 중에 프로세스 생성 시스템을 호출, 새로운 프로세스를 생성할 수 있음
        - 프로세스 생성 순서가 저장되고, 부모 - 자식 관계가 유지되며 계층적으로 생성됨
    - 프로세스 생성 시기
        - 일괄처리 환경 : 작업이 준비 큐에 도착할 때 프로세스 생성
        - 대화형 환경 : 새로운 사용자가 로그온 할때 프로세스 생성
      
- 프로세스 생성, 종료, 제거
    - 프로세스 생성 시 필요한 세부작업 순서
        - 새로운 프로세스에 프로세스 식별자 할당
        - 프로세스의 모든 구성 요소를 포함할 수 있느 ㄴ주소공간과 프로세스 제어블록 공간 할당
        - 프로세스 제어 블록 초기화
        - 링크
    - 프로세스 종료
        - 프로세스가 마지막 명령의 실행을 마치면 종료되고 운영체제에 프로세스의 삭제를 요청함
        - 일괄처리 환경 : 작업 종료 의미의 신호로 언터럽트 발생 또는 시스템 호출로 중지 명령을 전달
        - 대화형 환경 : 사용자가 로그오프 하거나 터미널을 닫음
        - abort 명령어로 프로세스 종료 (종료되는 프로세스를 생성한 부모 프로세스만 가능함)
        - 부모 프로세스의 자식 프로세스 종료
            - 보통 부모 프로세스 종료하면 운영체제가 자식 프로세스도 종료
            - 자식 프로세스가 할당된 자원을 초과하여 사용할 때
            - 자식 프로세스에 할당한 직업이 더는 없을 때
        - exit 명령어 : 유닉스에서 프로세스 종료
        - wait 명령어 : 부모 프로세스가 자식 프로세스의 종료 기다림
        - 이유
            - 정상 종료 : 프로세스가 응용체제의 서비스를 호출한 경우
            - 시간 초과 : 프로세스가 명시된 전체 시간을 초과하여 실행됨
            -  실패 : 파일 검색 실패, 입출력이 명시된 횟수 초과하여 실패
            - 오류 : 산술 오류, 보호 오류, 데이터 오류 등
            - 메모리 부족, 엑세스 위반 등
    - 프로세스의 중단과 재시작
        - 다중 프로그래밍에서의 중단
            - 프로세스 입출력 요구 외에 다른 원인으로 프로세스가 실행을 중단한 상태
            - 단일 처리 시스템 : 해당 프로세스가 스스로 중단함
            -  다중 처리 시스템 : 다른 프로세서가 실행중인 프로세스를 중단함
        - 프로세스의 재시작 
            - 중단된 프로세스는 다른 프로세서가 재시작 하기 전에는 실행 불가
            - 장시간 중단 시 해당 프로세스에 할당된 자원 반환, 자원의 성질에 따라 반환 자원 결정
            - 메인 메모리 : 프로세서 중단 즉시 반환
            - 보조 메모리 : 중단 시간을 예측할 수 없거나 너무 길 때 반환
            - 중단된 프로세스는 중단된 지점부터 다시 시작함
            
    - 프로세스 우선순위
        - 프로세스 스케줄러
            - 프로세스 제어 브롥의 우선순위 값을 변경할 수 있음
            - 프로세스 제어 블록의 우선순위를 이용하여 준비 리스트의 프로세스를 처리함
            - 준비 리스트의 프로세스는 프로세서 중심 프로세스(낮은 우선순위)와 입출력 중심 프로세스(높은 우선운위)로 구분됨
    
                    입출력 중심 프로세스
                        속도가 느리면서 빠른 응답을 요구하는 단말기 입출력 프로세스에 높은 우선순위 부여함
                        -> 시간 할당량을 적게 제공
                        속도가 빠른 디스크 입출력 프로세스에는 낮은 우선순위를 부여함
                        -> 시간 할당량을 많이 제공
                        입출력 중심 프로세스는 프로세서를 짧게 자주 사용하도록 함
                        프로세서 중심 프로세스는 프로세서를 한번에 오래 사용하되 사용 횟수를 줄여 균형을 유지함
    - 프로세스의 문맥 교환
        - 프로세스의 문맥 교환 발생
            - 오버헤드 발생
                - 메모리 속도, 레지스터 수, 특수 명령어의 유무에 따라 다름
                - 오버헤드는 시간, 비용이 소요되어 운영체제 설계 시에 불필요한 문맥 교환 감소가 주요 목표
            - 프로세스가 준비 -> 실행 상태로 바뀌거나 실행 -> 준비 또는 실행 -> 대기 상태로 바뀔 때 발생함
            - 레지스터 문맥 교환, 작업 문맥 교환, 스레드 문맥 교환, 프로세스 문맥 교환 등이 가능함
            
### 스레드 개념과 상태변화
- 스레드의 개념
    - 프로세스의 특성인 자원과 제어에서 제어만 분리한 실행 단위
        - 프로세스 하나는 스레드를 한개 이상으로 나눌 수 있음
        - 프로세스의 직접 실행정보를 제외한 나머지 프로세스 관리 정보는 공유함
        - 다른 프로시저 호출, 다른 실행 기록(별도 스택 필요)
        - 관련 자원과 함께 메모리 공유 가능하므로 손상된 데이터나 스레드의 이상 동작도 고려해야함
    - 스레드
        - 경량 프로세스 : 프로세스의 속성 중 일부가 들어있는 것
        - 중량 프로세스 : 스레드 하나에 프로세스 하나인 정통적인 경우
        - 같은 프로세스의 스레드는 같은 주소를 공유
    - 스레드의 구조
        - 스레드는 실행환경 정보, 지역데이터, 스택을 따로 관리함 하지만 SP, SR, PC는 같이 사용함
    - 스레드의 병렬 수행
        - 프로세스 하나에 포함된 스레드들은 공동의 목적 달성을 위해 병렬 수행함
        - 프로세스가 하나인 서로 다른 프로세서에서 프로그램의 다른 부분을 동시 실행함
        - 이점 :
            - 사용자 응답성 증가
            - 프로세스의 자원과 메모리 공유 가능
            - 경제성 좋음
            - 다중 처리로 성능과 효율 향상
    - 스레드와 프로세스의 관계
        - 단일 스레드 : 스레드 용어가 탄생하기 전이라 개념 불확실
        - 다중 스레드 : 프로그램 하나를 여러 실행 단위로 쪼개어 실행한다는 측면에서 다중 처리와 의미가 비슷함
    - 스레드의 상태 변화와 제어블록
        - 스레드의 상태변화
            - 프로세서를 함께 사용, 항상 스레드 하나만 실행됨
            - 한 프로세스에 있는 스레드는 순차적으로 실행됨
            - 프로세스를 생성하면 해당 프로세스의 스레드도 함께 생성됨
            - 프로세스의 생성과 종료보다는 오버헤드가 훨씬 적음
    - 스레드의 제어블록
        - 정보저장
        - 프로세스 제어블록은 스레드 제어블록의 리스트
        - 스레드 간에 보호하지 않음
    
### 스레드의 구현
- 스레드의 운영체제에 따른 구현
    - 사용자 수준 스레드 : 다대일 매핑, 스레드 라이브러리를 이용하여 작동, 속도가 빠름
    - 커널 수준 스레드 : 일대일 매핑, 커널(운영체제)에서 지원
    - 혼합형 스레드 : 다대다 매핑, 사용자 수준 스레드와 커널 수준 스레드를 혼합한 형태
    
- 사용자 수준 스레드
    - 장점 : 이식성 높음, 오버헤드 적음, 유연한 스케줄링 가능
    - 단점 : 시스템의 동시성을 지원하지 않음, 확장 제약이따름, 스레드 간 보호 불가능
    
- 커널 수준 스레드
    - 사용자 수준 스레드의 한계 극복 방법, 커널이 스레드와 관련된 모든 작업을 관리함
    - 특징 : 한 프로세스에서 다수의 스레드가 프로세서를 할당 받아 병행 수행
        - 스레드 한 개가 대기상태가 되면 동일한 프로세스에 속한 다른 스레드로 교환이 가능함
        - 커널이 직접 스케줄링하고 실행하므로 사용자 수준 스레드의 커널 지원 부족 문제를 해결할 수 있음
        - 커널이 전체 프로세스와 스레드 정보를 유지하여 오버헤드가 커짐
        - 커널이 각 스레드를 개별적으로 관리하여 동일한 프로세스의 스레드 병행 수행이 가능해짐
        - 동일한 프로세스에 있는 스레드 중 한개가 대기상태가 되어도 다른 스레드의 실행이 가능해짐
    
- 혼합형 스레드
    - 사용자 수준 스레드와 커널 수준 스레드를 혼합한 구조
    - 시스템 호출을 할 때 다른 스레드를 중단하는 다대일 매핑의 사용자 수준 스레드와, 스레드 수를 제한하는 일대일 매핑의커널 수준 스레드 문제 극복방안으로 제시
    - 기능 : 스레드 라이브러리가 최적의 성능 지원
        - 응용 프로그램이 커널 영역에서의 병렬 처리 정도를 결정할 수 있음
        - 스레드 풀링 이용하여 일대일 매핑으로 오버헤드 감소 가능
    
                스레드 풀링
                    미리 생성한 스레드의 재사용으로 스레드 생성 시간을 줄여 시스템의 부담 경감
                    동시 생성 가능한 스레드 수를 제한하여 시스템 자원의 낭비를 줄이고, 응용 프로그램의 전체 성능을 유지함
        
##### 문제
    
1. 다음 프로세스 관련 설명 중 틀린 것은?
    1. 프로그램이 메모리에 적재되면 프로세스가 된다.
    2. 작업 스케줄러는 선정한 작업의 상태를 변화시키며 프로세스의 생성에서 과정을 수행한다.
    3. 사용자 프로세스는 사용자 코드를 수행하는 프로세스이다.
    4. 프로세스 제어블록은 운영체제가 프로세스 제어 시 필요한 프로세스 상태 정보를 저장한다.
    
답 : 2. 프로세스 스케줄러는 선정한 작업의 상태를 변화시키며 프로세스의 생성에서 과정을 수행한다

2. 스레드의 상태 변화에 대한 설명으로 틀린 것은?
    1. 실행 상태의 스레드가 대기상태가 되면 다른 스레드 실행이 가능하다.
    2. 프로세스 하나에 있는 전체 스레드는 프로세스의 일부 조소에 접근 가능하다.
    3. 프로세스 생성과 종료보다 오버헤드가 훨씬 적다.
    4. 한 프로세스에 잇는 스레드는 순차적으로 실행된다.
    
답 : 2. 프로세스 하나에 있는 전체 스레드는 프로세스의 모든 주소에 접근 가능하다

3. 커널 수준의 스레드에 대한 설명으로 틀린것은?
    1. 사용자 수준 스레드의 커널 자원 부조고 문제 해결이 가능하다.
    2. 커널이 전체 프로세스와 스레드 정보를 유지하여 오버헤드가 커진다.
    3. 동일한 프로세스의 스레드 한개가 대기상태가 되면 이 중 어떤 스레드도 실행이 불가능하다.
    4. 스케쥴링 동기화를 하려면 더 많은 자원이 필요하다.
    
답 : 3. 커널에 최소 기능만 포함시켜 크기를 최소화 한 것은 마이크로 커널 구조 운영체제이다.